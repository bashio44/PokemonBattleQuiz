<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ポケモン対戦クイズ</title>
  <style>
    :root{
      --bg: #fff7f0; /* やわらかい背景色に変更 */
      --card: #ffffff;
      --primary: #007bff;
      --primary-dark: #0056b3;
      --radius: 12px;
      --gap: 12px;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      font-family: Inter, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      min-height: 100vh;
    }
    .quiz-container {
      background: var(--card);
      padding: clamp(16px, 3.5vw, 28px);
      border-radius: var(--radius);
      box-shadow: 0 6px 18px rgba(10,10,20,0.08);
      width: min(92vw, 640px);
      max-width: 95%;
      transition: transform 180ms ease;
      position: relative;
    }
    .quiz-container:focus-within,
    .quiz-container:hover {
      transform: translateY(-4px);
    }

    /* バトル領域：2x2 グリッド */
    .battle-grid {
      display: grid;
      grid-template-columns: 1fr 140px 180px; /* 左: info / 中央: icon / 右: name+HP */
      grid-template-rows: 140px 140px; /* 少し余白を増やし重なりを防止 */
      gap: 12px;
      align-items: center;
      position: relative;
      margin-bottom: 22px; /* 選択肢との重なりを防ぐために余白を増やす */
    }

    /* 左上: 敵の情報（情報を左上に） */
    .enemy-info {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
      text-align: left;
      padding: 10px;
      font-size: 14px;
    }
    .enemy-info .label { font-weight: 700; margin-bottom: 6px; display:block; }

    /* 右上: 敵アイコン */
    .enemy-icon {
      grid-column: 2 / 3;
      grid-row: 1 / 2;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      padding-right: 12px; /* 右側への余白（敵アイコンの右端距離）*/
      z-index: 2;
    }
    .enemy-icon img { width:100px; height:100px; }

    /* 左下: 味方アイコンと情報（左下に移動） */
    .ally-info {
      grid-column: 3 / 4; /* 右下 */
      grid-row: 2 / 3;
      text-align: right;
      padding: 10px;
      font-size: 14px;
    }
    .ally-icon-wrap {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display:flex;
      justify-content:flex-start;
      align-items:center;
      padding-left: 12px; /* 左側への余白（味方アイコンの左端距離）*/
      z-index: 2;
    }
    .ally-icon-wrap img { width:100px; height:100px; }
    .ally-namehp {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      padding: 8px 10px;
    }
    .enemy-namehp {
      grid-column: 3 / 4;
      grid-row: 1 / 2;
      padding: 8px 10px;
      text-align: right;
    }
    .name-label { font-weight:700; margin-bottom:8px; }
  /* 固定幅: 文字数6文字分の幅に調整 */
  .name-label { font-weight:700; margin-bottom:8px; display:block; color: #111; }
  /* 全角6文字分に相当させるため 12ch を使用（半角幅の2倍） */
  .name-label, .hp-wrap { width: 12ch; max-width: 12ch; box-sizing: border-box; }
  .name-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .hp-wrap { height:12px; background:#eee; border-radius:8px; overflow:hidden; }
    .hp-bar { height:100%; background:#4caf50; width:100%; transition: width 700ms ease; }
    .hp-text { font-size:13px; margin-top:6px; }

    /* spacer はそのまま保持（将来拡張用） */
    .spacer {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
    }

    /* 矢印と技名を重ねるローカルSVG（バトル領域全体を覆う） */
    .arrow-layer {
      position:absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      pointer-events: none;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 0; /* 背面に配置 */
    }
    .arrow-svg { width:100%; height:100%; overflow: visible; }
    /* 前面へ出す */
    .enemy-namehp, .ally-namehp, .enemy-info, .ally-info, .enemy-icon, .ally-icon-wrap { z-index: 2; position: relative; }
    /* move label background */
    .move-bg { fill: #ffe6d6; stroke: rgba(0,0,0,0.06); }

    /* 選択肢ボタン群 */
    #answers {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--gap);
      margin-top: 12px; /* 余白を増やす */
    }
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: clamp(10px, 2.4vw, 14px);
      border: none;
      border-radius: 10px;
      background: var(--primary);
      color: white;
      cursor: pointer;
      font-size: clamp(14px, 2.6vw, 16px);
      font-weight: 600;
      transition: background 120ms ease, transform 80ms ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      width: 100%;
      min-height: 44px;
    }
    button:hover { background: var(--primary-dark); }
    button:active { transform: translateY(1px) scale(0.997); }
    button:focus { outline: 3px solid rgba(0,123,255,0.18); outline-offset: 2px; }

    /* ...existing code... */

    #result {
      margin-top: 10px;
      font-weight: 700;
      font-size: 15px;
      min-height: 1.2em;
      transition: color 120ms ease;
      text-align:center;
    }

    @media (min-width: 900px) {
      .quiz-container { width: 640px; padding: 28px; }
      .battle-grid { grid-template-columns: 1fr 160px; grid-template-rows: 160px 160px; }
    }

    /* 自動切替: モバイル用レイアウト（幅が狭いとき） */
    @media (max-width: 600px) {
      .quiz-container { padding: 12px; }
      .battle-grid {
        grid-template-columns: 1fr;
        grid-template-rows: repeat(6, auto);
        gap: 10px;
      }
      .enemy-info { grid-column: 1; grid-row: 1; text-align: left; }
      .enemy-icon { grid-column: 1; grid-row: 2; transform: translateX(0); }
      .enemy-namehp { grid-column: 1; grid-row: 3; text-align: left; }
      .ally-namehp { grid-column: 1; grid-row: 4; text-align: left; }
      .ally-icon-wrap { grid-column: 1; grid-row: 5; transform: translateX(0); }
      .ally-info { grid-column: 1; grid-row: 6; text-align: left; }
      /* HPバーをやや小さくして全体幅を調整 */
      .hp-wrap { height: 10px; }
      .hp-text { font-size: 12px; }
      .enemy-icon img, .ally-icon-wrap img { width:72px; height:72px; }
      /* 技ラベルを少し小さく */
      #moveLabel { font-size: 16px; }
    }

    /* ダークモード配慮は不要のため削除しました */
  </style>
</head>
<body>
  <div class="quiz-container" role="main" aria-labelledby="question">
    <div class="battle-grid" id="battleGrid">
      <div class="enemy-info" id="enemyInfo">
        <div id="enemyEV">努力値: ？？？</div>
        <div id="enemyNature">性格: ？？？</div>
        <div id="enemyItem">持ち物: ？？？</div>
      </div>

      <div class="enemy-icon" id="enemyIconWrap">
        <img id="enemyIcon" src="" alt="敵ポケモン">
      </div>

      <div class="enemy-namehp">
        <div class="name-label" id="enemyName">ポケモン名</div>
        <div class="hp-wrap"><div id="enemyHpBar" class="hp-bar"></div></div>
        <div id="enemyHpText" class="hp-text">100%</div>
      </div>

      <div class="ally-namehp">
        <div class="name-label" id="allyName">ポケモン名</div>
        <div class="hp-wrap"><div id="allyHpBar" class="hp-bar"></div></div>
        <div id="allyHpText" class="hp-text">100 / 100</div>
      </div>

      <div class="ally-icon-wrap">
        <img id="allyIcon" src="" alt="味方ポケモン">
      </div>

      <div class="ally-info" id="allyInfo">
        <div id="allyEV">努力値: 0</div>
        <div id="allyNature">性格: 無補正</div>
        <div id="allyItem">持ち物: なし</div>
      </div>

        <!-- 防御側HPバー表示領域 -->
        <div id="defenderHpArea" style="grid-column: 2 / 3; grid-row: 2 / 3; display:none; align-items:center; flex-direction:column; justify-content:center;">
          <div id="defenderHpBarWrap" style="width:100px; height:16px; background:#eee; border-radius:8px; overflow:hidden; margin-bottom:4px;">
            <div id="defenderHpBar" style="height:100%; background:#4caf50; width:100%; transition:width 0.3s;"></div>
          </div>
          <div id="defenderHpText" style="font-size:13px; text-align:center;"></div>
        </div>

      <div class="arrow-layer" aria-hidden="true">
        <svg class="arrow-svg" id="arrowSvg">
          <defs>
            <marker id="arrowHead" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L8,4 L0,8 z" fill="#333"></path>
            </marker>
          </defs>
          <line id="arrowLine" x1="0" y1="0" x2="0" y2="0" stroke="#333" stroke-width="3" stroke-linecap="round" marker-end="url(#arrowHead)"></line>
          <rect id="moveBg" x="0" y="0" rx="10" ry="10" width="180" height="36" class="move-bg"></rect>
          <text id="moveLabel" x="50%" y="50%" text-anchor="middle" fill="#111" font-size="18" font-weight="700">技名</text>
        </svg>
      </div>
    </div>

    <!-- 問題文は不要なので削除 -->
    <div id="answers" aria-live="polite"></div>
    <p id="result" aria-atomic="true"></p>
  </div>

  <script>
    // CSV読み込み
    async function loadCSV(url) {
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.trim().split('\n');
      const header = lines[0].split(',');
      return lines.slice(1).map(line => {
        const values = line.split(',');
        const obj = {};
        header.forEach((h, i) => obj[h] = values[i]);
        return obj;
      });
    }

    const typeChart = {
      'ノーマル':   { 'いわ': 0.5, 'ゴースト': 0, 'はがね': 0.5 },
      'ほのお':     { 'くさ': 2, 'みず': 0.5, 'ほのお': 0.5, 'こおり': 2, 'むし': 2, 'いわ': 0.5, 'ドラゴン': 0.5, 'はがね': 2 },
      'みず':       { 'ほのお': 2, 'みず': 0.5, 'くさ': 0.5, 'じめん': 2, 'いわ': 2, 'ドラゴン': 0.5 },
      'でんき':     { 'みず': 2, 'でんき': 0.5, 'じめん': 0, 'ひこう': 2, 'くさ': 0.5, 'ドラゴン': 0.5 },
      'くさ':       { 'みず': 2, 'ほのお': 0.5, 'くさ': 0.5, 'じめん': 2, 'ひこう': 0.5, 'むし': 0.5, 'いわ': 2, 'ドラゴン': 0.5, 'はがね': 0.5 },
      'こおり':     { 'ほのお': 0.5, 'みず': 0.5, 'くさ': 2, 'じめん': 2, 'ひこう': 2, 'ドラゴン': 2, 'こおり': 0.5, 'はがね': 0.5 },
      'かくとう':   { 'ノーマル': 2, 'こおり': 2, 'いわ': 2, 'あく': 2, 'はがね': 2, 'ひこう': 0.5, 'エスパー': 0.5, 'むし': 0.5, 'ゴースト': 0, 'フェアリー': 0.5 },
      'どく':       { 'くさ': 2, 'どく': 0.5, 'じめん': 0.5, 'いわ': 0.5, 'ゴースト': 0.5, 'はがね': 0, 'フェアリー': 2 },
      'じめん':     { 'ほのお': 2, 'でんき': 2, 'くさ': 0.5, 'どく': 2, 'ひこう': 0, 'むし': 0.5, 'いわ': 2, 'はがね': 2 },
      'ひこう':     { 'くさ': 2, 'でんき': 0.5, 'ひこう': 0.5, 'むし': 2, 'いわ': 0.5, 'はがね': 0.5 },
      'エスパー':   { 'かくとう': 2, 'どく': 2, 'エスパー': 0.5, 'はがね': 0.5, 'あく': 0 },
      'むし':       { 'くさ': 2, 'ほのお': 0.5, 'かくとう': 0.5, 'どく': 0.5, 'ひこう': 0.5, 'エスパー': 2, 'ゴースト': 0.5, 'あく': 2, 'はがね': 0.5, 'フェアリー': 0.5 },
      'いわ':       { 'ほのお': 2, 'こおり': 2, 'かくとう': 0.5, 'じめん': 0.5, 'ひこう': 2, 'むし': 2, 'はがね': 0.5 },
      'ゴースト':   { 'ノーマル': 0, 'エスパー': 2, 'ゴースト': 2, 'あく': 0.5 },
      'ドラゴン':   { 'ドラゴン': 2, 'はがね': 0.5, 'フェアリー': 0 },
      'あく':       { 'エスパー': 2, 'かくとう': 0.5, 'あく': 0.5, 'フェアリー': 0.5 },
      'はがね':     { 'ほのお': 0.5, 'みず': 0.5, 'でんき': 0.5, 'こおり': 2, 'いわ': 2, 'はがね': 0.5, 'フェアリー': 2 },
      'フェアリー': { 'かくとう': 2, 'どく': 0.5, 'はがね': 0.5, 'ドラゴン': 2, 'あく': 2, 'フェアリー': 1 },
    };

    function getTypeEffectiveness(moveType, defenderTypes) {
      let eff = 1;
      defenderTypes.forEach(type => {
        if (!type) return;
        if (typeChart[moveType] && typeChart[moveType][type]) {
          eff *= typeChart[moveType][type];
        } else {
          eff *= 1;
        }
      });
      return eff;
    }

    function calcDamage({
      atkStat, defStat, movePower, moveType, defenderTypes, moveCategory = '物理',
      atkEV = 0, defEV = 0,
      atkNature = 'neutral', defNature = 'neutral',
      atkItem = '', defItem = ''
    }) {
      const level = 50;
      atkStat = Math.floor(atkStat + atkEV / 8);
      defStat = Math.floor(defStat + defEV / 8);
      const natureTable = { 'up': 1.1, 'down': 0.9, 'neutral': 1.0 };
      atkStat = Math.floor(atkStat * (natureTable[atkNature] || 1.0));
      defStat = Math.floor(defStat * (natureTable[defNature] || 1.0));
      let atkItemBoost = 1.0;
      if (atkItem === 'こだわりハチマキ' && moveCategory === "物理") atkItemBoost = 1.5;
      if (atkItem === 'こだわりメガネ' && moveCategory === "特殊") atkItemBoost = 1.5;
      atkStat = Math.floor(atkStat * atkItemBoost);
      if (defItem === '突撃チョッキ' && moveCategory === "特殊") {
        defStat = Math.floor(defStat * 1.5);
      }
      let base = (((2 * level / 5 + 2) * movePower * atkStat / defStat) / 50) + 2;
      const effectiveness = getTypeEffectiveness(moveType, defenderTypes);
      return Math.floor(base * effectiveness);
    }

    let pokemonStats = [];
    let pokemonMoves = [];

    const questionEl = null; // 問題文不要のため null
    const answersEl = document.getElementById("answers");
    const resultEl = document.getElementById("result");
    const enemyIcon = document.getElementById("enemyIcon");
    const allyIcon = document.getElementById("allyIcon");
    const enemyNameEl = document.getElementById("enemyName");
    const enemyEVElem = document.getElementById("enemyEV");
    const enemyNatureEl = document.getElementById("enemyNature");
    const enemyItemEl = document.getElementById("enemyItem");
    const allyNameEl = document.getElementById("allyName");
    const allyEVElem = document.getElementById("allyEV");
    const allyNatureEl = document.getElementById("allyNature");
    const allyItemEl = document.getElementById("allyItem");
  const moveLabel = document.getElementById("moveLabel");
  const arrowLine = document.getElementById("arrowLine");
  const arrowSvg = document.getElementById("arrowSvg");
  const defenderHpArea = document.getElementById("defenderHpArea");
  const defenderHpBar = document.getElementById("defenderHpBar");
  const defenderHpText = document.getElementById("defenderHpText");
  const enemyHpBar = document.getElementById('enemyHpBar');
  const enemyHpText = document.getElementById('enemyHpText');
  const allyHpBar = document.getElementById('allyHpBar');
  const allyHpText = document.getElementById('allyHpText');

    let correctAnswer = null;
    let score = 0;
    let total = 0;

    function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function drawArrow(fromEl, toEl, moveName) {
      if (!fromEl || !toEl) return;
      // SVG coordinates relative to svg bbox
      const svgRect = arrowSvg.getBoundingClientRect();
      const aRect = fromEl.getBoundingClientRect();
      const bRect = toEl.getBoundingClientRect();
        // アイコンの中心から少し外側にずらす（被り防止）
        const offset = 48; // アイコン半径+α
        // from: アイコンの中心からto方向にoffsetだけ離す
        const dx = bRect.left + bRect.width / 2 - (aRect.left + aRect.width / 2);
        const dy = bRect.top + bRect.height / 2 - (aRect.top + aRect.height / 2);
        const dist = Math.sqrt(dx*dx + dy*dy) || 1;
        const x1 = aRect.left + aRect.width / 2 - svgRect.left + (dx/dist)*offset;
        const y1 = aRect.top + aRect.height / 2 - svgRect.top + (dy/dist)*offset;
        const x2 = bRect.left + bRect.width / 2 - svgRect.left - (dx/dist)*offset;
        const y2 = bRect.top + bRect.height / 2 - svgRect.top - (dy/dist)*offset;
      arrowLine.setAttribute('x1', x1);
      arrowLine.setAttribute('y1', y1);
      arrowLine.setAttribute('x2', x2);
      arrowLine.setAttribute('y2', y2);
      moveLabel.textContent = moveName;
      // moveBg をテキスト幅に合わせる
      try {
        const bbox = moveLabel.getBBox();
        const pad = 16;
        const rect = document.getElementById('moveBg');
        rect.setAttribute('width', Math.max(80, bbox.width + pad));
        rect.setAttribute('x', bbox.x - pad/2);
        rect.setAttribute('y', bbox.y - 8);
      } catch (e) {
        // getBBox が失敗する環境では無視
      }
      // place moveLabel at midpoint
      const midX = (x1 + x2) / 2;
      const midY = (y1 + y2) / 2;
      moveLabel.setAttribute('x', midX);
      moveLabel.setAttribute('y', midY - 8); // 少し上に寄せる
    }

    function jpNatureLabel(n) {
      if (n === 'neutral') return '無補正';
      if (n === 'up') return '上昇';
      if (n === 'down') return '下降';
      return '無補正';
    }

    function generateQuiz() {
      if (!pokemonStats.length || !pokemonMoves.length) return;
      const attacker = getRandom(pokemonStats);
      const defender = getRandom(pokemonStats);
      const move = getRandom(pokemonMoves);

      let statKeyAtk = move["分類"] === "物理" ? "攻撃" : "特攻";
      let statKeyDef = move["分類"] === "物理" ? "防御" : "特防";
      const atkStat = Number(attacker[statKeyAtk]);
      const defStat = Number(defender[statKeyDef]);
      const movePower = Number(move["威力"]);
      const moveType = move["タイプ"];
      const defenderTypes = [defender["タイプ1"] || "ノーマル", defender["タイプ2"]].filter(Boolean);

      if (!movePower) return generateQuiz();

      // ランダム性格（簡易）と努力値・持ち物
      const natures = ['neutral','up','down'];
      const atkNature = getRandom(natures);
      const defNature = getRandom(natures);
      const atkEV = [0, 252][Math.floor(Math.random() * 2)];
      const defEV = [0, 252][Math.floor(Math.random() * 2)];
      const atkItems = ["", "こだわりハチマキ", "こだわりメガネ"];
      const defItems = ["", "突撃チョッキ"];
      const atkItem = atkItems[Math.floor(Math.random() * atkItems.length)];
      const defItem = defItems[Math.floor(Math.random() * defItems.length)];

      // 出題項目 (敵=当てる対象)
      const qTypes = ["atkEV", "atkItem", "defEV", "defItem"];
      const ask = qTypes[Math.floor(Math.random() * qTypes.length)];

      // 敵は「当てる対象」。ask が atk系なら attacker が敵、それ以外は defender が敵。
      const enemyIsAttacker = (ask === 'atkEV' || ask === 'atkItem');
      const enemy = enemyIsAttacker ? attacker : defender;
      const ally = enemyIsAttacker ? defender : attacker;

      // 表示用アイコン（固定配置：敵＝右上、味方＝左下）
      enemyIcon.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${Number(enemy["No"])}.png`;
      allyIcon.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${Number(ally["No"])}.png`;

      // 正しい値計算（ダメージは内部で使う）
      correctDamage = calcDamage({
        atkStat, defStat, movePower, moveType, defenderTypes,
        moveCategory: move["分類"],
        atkEV, defEV, atkNature, defNature, atkItem, defItem
      });

  // 防御側（ダメージを受ける側）のHPを表示（CSVのHP列を基に割合を計算）
  // ダメージを受ける対象は常に変数 `defender`（先に選んだ防御側）です。
  const target = defender;
  const targetBaseHP = Number(target["HP"] || 100);
  const afterHp = Math.max(0, targetBaseHP - correctDamage);
  const afterRatio = Math.max(0, Math.min(1, afterHp / targetBaseHP));

      // 味方と敵それぞれのHPバーを同じ固定幅にリセット（見た目同サイズ）
      if (enemyHpBar && allyHpBar) {
        enemyHpBar.style.width = '100%';
        allyHpBar.style.width = '100%';
        enemyHpText.textContent = '100%';
        allyHpText.textContent = `100 / 100`;
      }

      // ダメージは target に当たるので該当バーをアニメーションで減らす
      setTimeout(() => {
        // defender 変数が現在の "enemy" オブジェクトと等しければ敵が被弾、
        // そうでなければ味方が被弾と判定して、それぞれのバーを減らす
        const defenderIsEnemy = (defender === enemy);
        if (defenderIsEnemy) {
          if (enemyHpBar) enemyHpBar.style.width = `${Math.round(afterRatio * 100)}%`;
          if (enemyHpText) enemyHpText.textContent = `${Math.round(afterRatio * 100)}%`;
        } else {
          if (allyHpBar) allyHpBar.style.width = `${Math.round(afterRatio * 100)}%`;
          if (allyHpText) allyHpText.textContent = `${Math.max(0, Math.round(afterHp))} / ${targetBaseHP}`;
        }
      }, 200);

      // 描画する情報（味方は全て表示、敵は不明箇所を ??? にする）
      const enemyEVVal = (enemyIsAttacker ? atkEV : defEV);
      const enemyItemVal = (enemyIsAttacker ? atkItem : defItem);
      const enemyNatureVal = (enemyIsAttacker ? atkNature : defNature);

      const allyEVVal = (enemyIsAttacker ? defEV : atkEV);
      const allyItemVal = (enemyIsAttacker ? defItem : atkItem);
      const allyNatureVal = (enemyIsAttacker ? defNature : atkNature);

      // 表示：敵（左上情報、右上アイコン）
      enemyNameEl.textContent = enemy["名前"];
      enemyEVElem.textContent = '努力値: ' + ((ask === 'atkEV' && enemyIsAttacker) || (ask === 'defEV' && !enemyIsAttacker) ? '？？？' : String(enemyEVVal));
      enemyNatureEl.textContent = '性格: ' + jpNatureLabel(enemyNatureVal);
      enemyItemEl.textContent = '持ち物: ' + ((ask === 'atkItem' && enemyIsAttacker) || (ask === 'defItem' && !enemyIsAttacker) ? '？？？' : (enemyItemVal || 'なし'));

      // 表示：味方（左下）
      allyNameEl.textContent = ally["名前"];
      allyEVElem.textContent = '努力値: ' + String(allyEVVal);
      allyNatureEl.textContent = '性格: ' + jpNatureLabel(allyNatureVal);
      allyItemEl.textContent = '持ち物: ' + (allyItemVal || 'なし');

      // moveLabel を技名にセット（矢印に重ねる）
      moveLabel.textContent = move["技名"];

      // 選択肢と正誤設定（敵の不明箇所を当てる）
      let choices = [];
      if (ask === "atkEV" || ask === "defEV") {
        choices = [0, 252].map(String);
        correctAnswer = String(enemyEVVal);
      } else if (ask === "atkItem") {
        choices = atkItems.map(v => v || "なし");
        correctAnswer = (enemyItemVal || "なし");
      } else if (ask === "defItem") {
        choices = defItems.map(v => v || "なし");
        correctAnswer = (enemyItemVal || "なし");
      }
      choices.sort(() => Math.random() - 0.5);

      answersEl.innerHTML = "";
      choices.forEach(answer => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = answer;
        btn.onclick = () => checkAnswer(answer);
        answersEl.appendChild(btn);
      });
      resultEl.textContent = "";

      // 矢印を描く（画像読み込み後に実行）
      const fromEl = (attacker === enemy) ? document.getElementById('enemyIcon') : document.getElementById('allyIcon');
      const toEl = (defender === enemy) ? document.getElementById('enemyIcon') : document.getElementById('allyIcon');

      function redraw() {
        drawArrow(fromEl, toEl, move["技名"]);
      }
      setTimeout(redraw, 80);
      enemyIcon.onload = redraw;
      allyIcon.onload = redraw;
    }

    function checkAnswer(answer) {
      total++;
      if (String(answer) === String(correctAnswer)) {
        score++;
        resultEl.textContent = "✅ 正解！";
        resultEl.style.color = "green";
      } else {
        resultEl.textContent = `❌ 不正解... 正解は ${correctAnswer}`;
        resultEl.style.color = "red";
      }
      setTimeout(generateQuiz, 1200);
    }

    // CSVロード後にクイズ開始
    Promise.all([
      loadCSV('pokemon_stats.csv'),
      loadCSV('pokemon_moves.csv')
    ]).then(([stats, moves]) => {
      pokemonStats = stats;
      pokemonMoves = moves;
      generateQuiz();
    }).catch(err => {
      console.error(err);
    });

  </script>
</body>
</html>
